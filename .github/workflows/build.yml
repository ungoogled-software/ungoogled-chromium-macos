name: Build macOS binaries of Ungoogled Chromium
on:
  workflow_dispatch:
  push:
    paths:
      - 'patches/**'
      - 'downloads.ini'
      - 'revision.txt'
      - 'flags.macos.gn'
      - '!build.sh'
      - '!README.md'
      - '!LICENSE'
      - '!devutils/**'
      - '.github/scripts/force_build.txt'

jobs:
  retrieve-resources:
    name: Retrieve resources required for building
    runs-on: macos-13
    steps:
      - name: Clone repository
        uses: actions/checkout@v4
        with:
          submodules: true
      - name: Copy GitHub specific scripts to git-root folder
        run: cp -va ./.github/scripts/ ./
      - name: Disable Spotlight
        run: sudo mdutil -a -i off
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install coreutils
        run: brew install coreutils
      - name: Download and unpack required resources
        run: ./github_fetch_resources.sh | tee -a github_actions_retrieve_resources.log
      - name: List resources
        run: ls -la
      - name: Archive resources
        run: ./github_pack_resources.sh | tee -a github_actions_retrieve_resources.log
      - name: Upload resources
        uses: actions/upload-artifact@v3
        with:
          name: ungoogled_chromium_macos_resources
          path: upload_build_resources/

  build:
    needs: retrieve-resources
    name: Build macOS binaries of Ungoogled Chromium
    strategy:
      matrix:
        arch: [x86-64, arm64]
      fail-fast: true
      max-parallel: 2
    uses: ./.github/workflows/building.yml
    with:
      arch: ${{ matrix.arch }}

  release:
    needs: build
    if: github.event_name == 'push' && contains(github.ref, 'refs/tags/')
    name: Release macOS binaries of Ungoogled Chromium
    runs-on: macos-13
    steps:
      - name: Clone repository
        uses: actions/checkout@v4
        with:
          submodules: true
      - name: Copy GitHub specific scripts to git-root folder
        run: cp -va ./.github/scripts/ ./
      - name: Disable Spotlight
        run: sudo mdutil -a -i off
      - name: Install coreutils
        run: brew install coreutils
      - name: Prepare release
        id: bake
        run: ./github_prepare_release.sh | tee -a github_actions_release.log
      - name: Get built x86-64 binary
        uses: actions/download-artifact@v3
        with:
          name: ${{ steps.bake.outputs.x64_file_name }}
      - name: Get built arm64 binary
        uses: actions/download-artifact@v3
        with:
          name: ${{ steps.bake.outputs.arm64_file_name }}
      - name: List files
        run: ls -la
      - name: Generate release note
        run: ./github_generate_release_note.sh | tee -a github_actions_release.log
      - name: Release Ungoogled-Chromium binaries
        uses: softprops/action-gh-release@v1
        with:
          body_path: ./github_release_note.md
          draft: false
          prerelease: false
          files: |
            ./release_asset/${{ steps.bake.outputs.x64_file_name }}
            ./release_asset/${{ steps.bake.outputs.arm64_file_name }}
          name: ${{ steps.bake.outputs.release_name }}
          tag_name: ${{ steps.bake.outputs.release_tag_version }}
          token: ${{ secrets.GITHUB_TOKEN }}
